apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: rucio-db
  namespace: postgresql
spec:
  instances: 1

  imageName: ghcr.io/cloudnative-pg/postgresql:16

  # PostgreSQL storage 설정
  storage:
    size: 500Gi
    storageClass: rook-ceph-block-hot  

  # 초기 데이터베이스와 사용자 자동 생성
  bootstrap:
    initdb:
      database: rucio
      owner: joon
      secret:
        name: rucio-db-secret 
  
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: '1'
      memory: 2Gi

  # Monitoring 설정
  monitoring:
    enablePodMonitor: false
---
# Nessie DB Cluster
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: nessie-db
  namespace: lakehouse
spec:
  instances: 1 # Sandbox 환경이므로 1개로 시작 (필요 시 2~3개로 증설 가능)
  imageName: ghcr.io/cloudnative-pg/postgresql:16
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
          - matchExpressions:
              - key: kubernetes.io/hostname
                operator: In
                values:
                  - sandbox-3
  storage:
    size: 100Gi # Nessie 메타데이터용
    storageClass: rook-ceph-block-hot 
    
  bootstrap:
    initdb:
      database: nessie
      owner: nessie
      secret:
        name: nessie-db-secret

  monitoring:
    enablePodMonitor: false
